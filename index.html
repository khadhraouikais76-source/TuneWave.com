<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TuneWave - Free Music Player</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background: linear-gradient(135deg,#1e3c72,#2a5298); color:#fff; }
header { padding:20px;text-align:center;background: rgba(0,0,0,.4);}
input, select, button { padding:10px; border-radius:20px; border:none; outline:none; margin:5px; font-size:15px;}
button { background:#1db954;color:#fff;cursor:pointer;}
.results { padding:15px; display:flex; flex-wrap:wrap; justify-content:center; gap:15px;}
.card { width:90%; max-width:300px; background: rgba(0,0,0,.6); border-radius:20px; padding:12px; text-align:center;}
.card img { width:100%; border-radius:15px; }
audio { width:100%; margin-top:8px; }
.download-btn { margin-top:10px; font-size:22px; border-radius:50%; padding:10px 14px; background:#ff6f61; cursor:pointer; }
.overlay { position:fixed; inset:0; background: rgba(0,0,0,.6); display:none; z-index:1000; }
.loader-box { position:fixed; top:50%; left:50%; transform: translate(-50%,-50%); display:none; text-align:center; z-index:1001; }
.loader { width:70px; height:70px; border:7px solid rgba(255,255,255,.3); border-top:7px solid #1db954; border-radius:50%; animation: spin 1s linear infinite; margin:auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111; padding:20px; border-radius:20px; display:none; z-index:1002; width:90%; max-width:320px; text-align:center; }
.progress { width:100%; height:16px; background:#333; border-radius:10px; overflow:hidden; margin-top:15px; }
.progress-bar { height:100%; width:0%; background:#1db954; transition: width 0.2s; }
</style>
</head>
<body>

<header>
<h2>TuneWave</h2>
<input id="searchBox" placeholder="Search song or artist">
<select id="genre">
  <option value="">All</option>
  <option value="pop">Pop</option>
  <option value="rock">Rock</option>
  <option value="hip hop">Hip Hop</option>
</select>
<br>
<button onclick="search()">Search</button>
</header>

<div class="results" id="results"></div>

<div class="overlay" id="overlay"></div>
<div class="loader-box" id="loaderBox"><div class="loader"></div><p>Searching...</p></div>

<div class="popup" id="popup">
  <h4 id="popupTitle"></h4>
  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  <p id="progressText">0%</p>
</div>

<script>
const API = "https://yt-1-jfka.onrender.com";

function showLoader(show){
  document.getElementById("overlay").style.display = show?"block":"none";
  document.getElementById("loaderBox").style.display = show?"block":"none";
}

async function search(){
  const q = searchBox.value.trim();
  const g = genre.value;
  if(!q && !g) return alert("Enter search text");
  results.innerHTML = "";
  showLoader(true);
  try {
    const res = await fetch(`${API}/search?q=${encodeURIComponent(q+" "+g)}`);
    const json = await res.json();
    const data = json.results || json;
    if(!data || data.length===0){ results.innerHTML="No results"; return;}
    data.forEach(t=>{
      if(!t.audio) return;
      results.innerHTML += `
      <div class="card">
        <img src="${t.image}">
        <h4>${t.title}</h4>
        <p>${t.artist}</p>
        <audio controls src="${t.audio}"></audio>
        <button class="download-btn" onclick="download('${t.audio}','${t.title.replace(/'/g,'')}')">⬇</button>
      </div>`;
    });
  } catch(e){ results.innerHTML="Error loading results"; }
  finally{ showLoader(false); }
}

// دالة Download
function download(url, title){
  popupTitle.innerText = title;
  overlay.style.display = "block";
  popup.style.display = "block";
  progressBar.style.width = "0%";
  progressText.innerText = "Waiting...";

  if(window.Android && Android.downloadFile){
    // WebView: ينادي Android function لفتح SAF
    Android.downloadFile(url, title + ".mp3");
    progressBar.style.width = "0%";
    progressText.innerText = "Waiting for user...";
  } else {
    // Browser fallback: تحميل عبر XMLHttpRequest مع Progress
    const xhr = new XMLHttpRequest();
    xhr.open("GET", url);
    xhr.responseType = "blob";

    xhr.onprogress = function(e){
      if(e.lengthComputable){
        const percent = Math.floor((e.loaded / e.total) * 100);
        progressBar.style.width = percent + "%";
        progressText.innerText = percent + "%";
      }
    };

    xhr.onload = function(){
      if(xhr.status === 200){
        const blobUrl = URL.createObjectURL(xhr.response);
        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = title + ".mp3";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);

        progressBar.style.width = "100%";
        progressText.innerText = "Download Complete";
        setTimeout(closePopup, 1000);
      } else {
        progressText.innerText = "Download Failed";
        setTimeout(closePopup, 1000);
      }
    };

    xhr.onerror = function(){
      progressText.innerText = "Download Error";
      setTimeout(closePopup, 1000);
    };

    xhr.send();
  }
}

function closePopup(){
  popup.style.display = "none";
  overlay.style.display = "none";
}
</script>
</body>
</html>